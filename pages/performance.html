<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Performance Tester</title>
	<link rel="icon" href="data:;base64,iVBORw0KGgo=">
	<link rel="stylesheet" href="../assets/html.css">
	<script src="../assets/por.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.1.1.slim.min.js"></script>

	<style>
		body {
			font-family: sans-serif;
		}
		.main-panel {
			width: 100%;
			min-width: 500px;
		}
		big {
			font-size: 1.5em;
		}
		input {
			width: 40px;
		}
		textarea {
			width: 100%;
			max-width: 100%;
			height: 120px;
			box-sizing: border-box;
		}
		#teardown_ta {
			height: 66px;
		}
		
		.control-line {
			display: flex;
			align-items: center;
			justify-content: space-between;
		}
		.control-line button {
			font-size: 1.2em;
		}
		.error {
			color: red;
		}
		
		table { 
			width: 100%;
		}
		thead td {
			text-align: center;
			font-weight: bold;
		}
		td {
			padding: 8px;
			border: 1px solid lightgrey;
		}
		tbody td {
			text-align: right;
		}
		tr:nth-child(even) td {
			background-color: #efefef;
		}
		tr.slowest td {
			background-color: lightpink;
		}
		tr.fastest td {
			background-color: lightgreen;
		}
		.test-case {
			width: 100%;
			max-width: 400px;
			height: 100%;
			display: inline-block;
			white-space: nowrap;
			overflow:hidden;
			text-overflow: ellipsis;
			box-sizing: border-box;
			cursor: pointer;
			user-select: none;
		}
		.test-case.selected {
			box-shadow: inset 0 0 0 1px blue;
		}
	</style>
</head>
<body>
	<div class="main-panel">
		<div>
			<div>
				<big>Tear up</big>
				<small>The code in this phase will not be included in the performance calculation and is performed only once.</small>
			</div>
			<textarea id="tearup_ta" placeholder="var obj = {};"></textarea>
		</div>
		<br>
		<div>
			<div><big>Actual Test</big></div>
			<textarea id="test_ta"></textarea>
		</div>
		<br>
		<div>
			<div>
				<big>Tear down</big>
				<small>The code in this phase will not be included in the performance calculation and is performed only once.</small>
			</div>
			<textarea id="teardown_ta" placeholder="delete obj; "></textarea>
		</div>
		<br>
		<fieldset>
			<legend>Test Settings</legend>
			<span>Time Limit (ms):</span>
			<input id="time_limit_in">
			<span>Number of execution:</span>
			<input id="num_exec_in">
		</fieldset>
		<br>
		<div class="control-line">
			<button id="start_btn">Start Performance Test</button>
			<button id="clear_btn">Clear Result(s)</button>
		</div>
		<br>
		<div id="status_line">No Test Result</div>
		<br>
		<table>
			<thead>
				<tr>
					<td>#</td>
					<td><div>Avg. execution time (ms)</div><div>The lesser, the better</div></td>
					<td><div>Avg. number of execution</div><div>The higher, the better</div></td>
					<td><div>Speed Ratio</div><div>Maximum is 1</div></td>
					<td><div>Test Case</div></td>
				</tr>
			</thead>
			<tbody id="result_tbl"></tbody>
		</table>
	</div>

<script>
	if(window.localStorage) { // In IE, localStorage may not exist
		time_limit_in.value = window.localStorage.getItem("time_limit_in") || "100";
		num_exec_in.value = window.localStorage.getItem("num_exec_in") || "30";
		tearup_ta.value = window.localStorage.getItem("tearup_ta") || "";
		test_ta.value = window.localStorage.getItem("test_ta") || "";
		teardown_ta.value = window.localStorage.getItem("teardown_ta") || "";
	}

	var _actualTest, _noOfExec, _timeLimit, _batchSize, _totalTime, _execCounts, _curCycle, _runningPerf, _lastClickedTestCase;

	start_btn.addEventListener("click", function(e) {
		if(!_parseInputs()) {
			return;
		}
		
		if(_runningPerf) { // Prevent running perf test twice during the test
			return;
		}
		_runningPerf = true;
		
		if(window.localStorage) { // In IE, localStorage may not exist
			window.localStorage.setItem("time_limit_in", time_limit_in.value);
			window.localStorage.setItem("num_exec_in", num_exec_in.value);
			window.localStorage.setItem("tearup_ta", tearup_ta.value);
			window.localStorage.setItem("test_ta", test_ta.value);
			window.localStorage.setItem("teardown_ta", teardown_ta.value);
		}
		
		_timeLimit = +time_limit_in.value || 100;
		_noOfExec = +num_exec_in.value || 30;
		_batchSize = 10;
		_totalTime = 0;
		_execCounts = [];
		_curCycle = 0;
		
		status_line.textContent = "Executing... [1]";
		setTimeout(_onTimer);
	});
	clear_btn.addEventListener("click", function(e) {
		while (result_tbl.firstChild) {
			result_tbl.removeChild(result_tbl.firstChild);
		}
		_lastClickedTestCase = null;
	});

	function _onTimer() {
		var execCount = 0;
		var timeElapsed = 0;

		while (timeElapsed < _timeLimit){
			var diff = _actualTest(_batchSize);
			_totalTime += diff;
			timeElapsed += diff;
			execCount += _batchSize;
			if(diff <= 0) {
				_batchSize++;
			} else if(_batchSize > 1 && diff > _timeLimit) {
				_batchSize--;
			}
		}
		_execCounts.push(execCount);
		_curCycle++;
		if(_curCycle < _noOfExec) {
			status_line.textContent = "Executing... [" + (_curCycle + 1) + "]";
			setTimeout(_onTimer);
		} else {
			_concludeResults();
		}
	}

	function _concludeResults() {
		_runningPerf = false;
		status_line.textContent = "Done";
		
		var totalCount = 0;
		for (var k = _noOfExec; --k >= 0;) {
			totalCount += _execCounts[k];
		}
		var avgTime = Math.floor(_totalTime / totalCount * 100000) / 100000;

		var td0 = document.createElement('td');
		var td1 = document.createElement('td');
		var td2 = document.createElement('td');
		var td3 = document.createElement('td'); 
		var td4 = document.createElement('td');
		td0.textContent = result_tbl.children.length + 1;
		td1.textContent = avgTime.toFixed(5);
		td2.textContent = (Math.floor(totalCount / _noOfExec * 100) / 100).toFixed(2);
		// td3.textContent = "";
		var div = document.createElement("div");
		div.className = "test-case";
		var testText = div._testText = test_ta.value;
		var shortenText = testText.length > 1000 ? testText.substr(0, 1000) : testText;
		div.textContent = shortenText;
		div.title = shortenText;
		div.addEventListener("click", onTestCaseClicked);
		div.addEventListener("dblclick", onTestCaseDblClicked);
		td4.appendChild(div);
		
		var tr = document.createElement('tr');
		tr.appendChild(td0);
		tr.appendChild(td1);
		tr.appendChild(td2);
		tr.appendChild(td3);
		tr.appendChild(td4);
		
		result_tbl.insertBefore(tr, result_tbl.firstChild);
		
		// Find slowest and fastest results
		var children = result_tbl.children;
		var min = NaN, max = NaN;
		for(k = children.length; --k >= 0;) {
			tr = children[k];
			var val = +tr.cells[2].textContent;
			if(!(val >= min)) {
				min = val;
				minAt = k;
			}
			if(!(val <= max)) {
				max = val;
				maxAt = k;
			}
			tr.className = "";
		}
		var maxVal = +children[maxAt].cells[2].textContent;
		for(k = children.length; --k >= 0;) {
			tr = children[k];
			var val = +tr.cells[2].textContent;
			tr.cells[3].textContent = (Math.floor(val / maxVal * 10000) / 10000).toFixed(4);
		}
		
		if(minAt !== maxAt) {
			children[minAt].className = "slowest";
			children[maxAt].className = "fastest";
		}
	}
	
	function onTestCaseClicked(e) {
		var elem = e.currentTarget;
		if(elem !== _lastClickedTestCase) {
			if(_lastClickedTestCase) {
				_lastClickedTestCase.classList.remove("selected");
			}
			_lastClickedTestCase = elem; 
			elem.classList.add("selected");
		}
	}
	function onTestCaseDblClicked(e) {
		var elem = e.currentTarget;
		test_ta.value = elem._testText;
		e.preventDefault();
		e.stopPropagation();
	}
	
	function _parseInputs() {
		status_line.classList.remove("error");
		status_line.textContent = "Parsing...";
		try {
			_actualTest =
				eval("(function(__batchSize) { "
				+ tearup_ta.value + ";\n"
				+ "var __begin = new Date().getTime();\n"
				+ "for(var __j = __batchSize; --__j >= 0;) {\n"
				+ test_ta.value + ";\n"
				+ "} var __end = new Date().getTime();\n"
				+ teardown_ta.value + ";\n"
				+ "return __end - __begin;})");
			_actualTest(1); // Test the parsed function once
			return true;
		} catch(err) {
			status_line.classList.add("error");
			status_line.textContent = err.message;
		}
		return false;
	}
</script>

</body>
</html>