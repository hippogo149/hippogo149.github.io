<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Financial Statement Prettifier</title>

	<link rel="icon" href="data:;base64,iVBORw0KGgo=">
	<link rel="stylesheet" href="../assets/html.css">
	<script src="../assets/por.min.js"></script>
	<script src="../assets/HtmlDocument.min.js"></script>
	
	<style>
		body { font-family: arial;}
		#error_span { color: red; }
		textarea {
			white-space: nowrap;
			overflow: auto;
		}

		.hsect {
			font-weight: bold;
			margin-bottom: 8px;
		}
	</style>
</head>
<body>
	<div class="hsect">Financial Statement : <span id="error_span"></span> <span id="release_span"></span></div>
	<div id="report_div"></div>
	<br>
	<div>
		<div class="hsect">Quarter and Consolidated F/S (F45-3) :</div>
		<textarea id="userInput" onfocus="this.select()" onkeyup="extractReport()" cols="100" rows="24"></textarea>
	</div>
	<br>
	<b>Source Link: </b><a id="ref_link" href="https://www.set.or.th/set/newslist.do?symbol=" target="_blank">https://www.set.or.th/set/newslist.do?symbol=</a>

<script>
	var cb = new CanvasBox(0, 723, 412);
	cb.getElement();
	cb.setParent(report_div);
	cb.setTextAlign("c", "m");
	
	var defaultHeight = 23;
	var tbls = new Array(3);
	var defs = new Array(3);
	var getCell = function(t, c, r) {
		var tbl = tbls[t];
		if(tbl) {
			return tbl.getState().getCell(c, r);
		}
		return null
	};
	
	defs[0] = {
		 canvas: cb
		,x: 1
		,y: 1
		,style: {
			 font: "normal 16px Arial"
			,textAlign: "center"
			,borderColor: "lightgrey"
			,backgroundColor: "white"
			,color: "black"
		}
		,oddStyle: {
			backgroundColor: "#EFEFFF"
		}
	};
	
	defs[0].widths = Ary.create(5, 123);
	defs[0].widths[0] = 230;
	defs[1] = Ut.cloneObject(defs[0]);
	
	defs[0].heights = Ary.create(3, defaultHeight);
	defs[0].content = [
		 ["สรุปผลการดำเนินงานของบจ.และรวมของบริษัทย่อย (F45-3)"]
	];
	defs[0].spans = [
		 [0, 4, 0]
		,[0, 4, 1]
		,[0, 4, 2]
	];
	
	defs[1].y += defaultHeight * defs[0].heights.length + 10;
	defs[1].heights = Ary.create(7, defaultHeight);
	defs[1].content = [
		 ["งบการเงินรวม"]
		,[""]
		,["สิ้นสุดวันที่"]
		,["ปี"]
		,["กำไร (ขาดทุน) สุทธิ"]
		,["กำไร (ขาดทุน) สุทธิ ต่อหุ้น (บาท)"]
		,["% เปลี่ยนแปลง"]
	];
	defs[1].spans = [
		 [0, 4, 0]
		,[1, 2, 1]
		,[3, 4, 1]
		,[1, 2, 2]
		,[3, 4, 2]
		,[1, 2, 6]
		,[3, 4, 6]
	];
	
	defs[2] = Ut.cloneObject(defs[1]);
	defs[2].y = defs[1].y + defaultHeight * defs[1].heights.length + 10;
	defs[2].content = defs[1].content.concat();
	defs[2].content[0] = ["งบการเงินเฉพาะกิจการ"];
	
	for(var i = defs.length; --i >= 0;) {
		tbls[i] = new CanvasCells(defs[i]);
	}
	
	var boldFont = {font: "bold 16px Arial"};
	var alignRight = {textAlign: "right"};
	for(var t = 1; t < 3; ++t) {
		tbls[t].getState().getColumn(0).style = {textAlign: "left"};
		getCell(t, 0, 0).style = boldFont;
		getCell(t, 1, 6).style = Ut.cloneObject(boldFont);
		getCell(t, 3, 6).style = Ut.cloneObject(boldFont);
		for(var c = 1; c < 5; ++c) {
			getCell(t, c, 4).style = alignRight;
			getCell(t, c, 5).style = alignRight;
		}
	}
	
	var drawTable = function() {
		cb.clearCanvas();
		cb.fillBg("#fff");
		for(var i = tbls.length; --i >= 0;) {
			tbls[i].drawTable();
		}
	};
	drawTable();
</script>
	
<script>
	userInput.setAttribute("placeholder", "แปะ สรุปผลการดำเนินงานของไตรมาส (F45-3) ที่นี่");
	
	var reportName = "(F45-3)";
	var args = QArgs.extract(location.search);
	var symbol = "";
	if(args) {
		symbol = args.s;
		if(symbol) {
			var refLink = ref_link.textContent.replace("%s", symbol);
			ref_link.setAttribute("href", refLink);
			ref_link.textContent = refLink;
			
			var now = new Date();
			var date = now.getDate();
			date = (date < 10) ? "0" + date : "" + date; 
			var month = now.getMonth() + 1;
			month = (month < 10) ? "0" + month : "" + month; 
			var year = now.getFullYear();
			var settrade = "https://www.set.or.th/set/newslist.do" +
				"?source=company&symbol=" + symbol.toUpperCase() + 
				"&securityType=&newsGroupId=3&headline=" +
				"&from=" + date + "%2F" + month + "%2F" + (year - 1) + 
				"&to=" + date + "%2F" + month + "%2F" + year + 
				"&submit=%E0%B8%84%E0%B9%89%E0%B8%99%E0%B8%AB%E0%B8%B2" + 
				"&language=th&country=TH";
				
			Ut.post("http://localhost:3020/api/load", {
				"url": settrade,
				"cookie": 'IPO_Language=English'
			})
			.then(function(res) {
				var txt = HtmlDocument.isolateBodyTag(res.document);
				var linkRow = HtmlDocument.retrieveTag(txt, reportName, "tr");
				if(!linkRow) {
					reportName = "(F45-1)";
					linkRow = HtmlDocument.retrieveTag(txt, reportName, "tr");
					if(!linkRow) {
						return Promise.reject("No F45-3 report detected");
					}
				}
				
				var linkCells = HtmlDocument.extractTags(linkRow, "td");
				var thaiDateTime =  HtmlDocument.extractInnerHTML(linkCells[0]);
				
				var prevD = convertThaiDateTime(thaiDateTime);
				if(!prevD) {
					return Promise.reject("Unable to extract date time.");
				}
				
				var curD = new Date();
				var diffD = Math.floor((curD - prevD) / 86400000);
				release_span.textContent = "Released " + diffD + 
				" day(s) ago (" + thaiDateTime + ")";
				
				var link = HtmlDocument.retrieveTag(linkCells[5], "href", "a");
				
				var domain = "https://www.set.or.th";
				link = HtmlDocument.replaceRelativePaths(link, domain);
				
				var href = HtmlDocument.extractAttributeValue(link, "href");
				return Ut.post("http://localhost:3020/api/load", {
					"url": href.replace(/&amp;/g, "&")
				});
			})
			.then(function(res) {
				var txt = HtmlDocument.isolateBodyTag(res.document);
				var divReport = HtmlDocument.retrieveTag(txt, "newsstory-pre-font", "pre");
				if(!divReport) {
					return Promise.reject("No report detected");
				}
				
				// userInput.value = HtmlDocument.replaceBR(divReport);
				userInput.value = HtmlDocument.extractInnerHTML(divReport);
				extractReport();
			})
			.catch(function(err) {
				var errStr = err.message || err;
				var errElem = HtmlDocument.isolateBodyTag(errStr);
				if(errElem) {
					error_span.innerHTML = errElem;
				} else {
					console.log(err);
					error_span.textContent = errStr;
				}
			});
		}
	}
	function convertThaiDateTime(thaiDT) {
		if(!thaiDT) {
			return null;
		}
		// Expect "27 ส.ค. 2561 08:27" format
		var chunks = thaiDT.split(/\s+/g);
		chunks = Ary.removeEmptyItems(chunks);
		if(chunks.length !== 4) {
			return null;
		}
		// var timeChunks = chunks[3].split(":");
		var thaiMonths = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย", "พ.ค", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."];
		return new Date(
			(+chunks[2] - 543), 
			thaiMonths.indexOf(chunks[1]), 
			+chunks[0]
		);
	}
	
	function extractReport() {
		var inputStr = userInput.value;
		var lines = inputStr.split("\n");
		var combStart = searchLines(lines, "งบการเงินรวม");
		if(combStart < 0) {
			combStart = searchLines(lines, "The Consolidated Financial Statement");
		}
		var indiStart = searchLines(lines, "งบการเงินเฉพาะกิจการ");
		if(indiStart < 0) {
			indiStart = searchLines(lines, "The Company Financial Statement");
		}
		var nameStart = (combStart >= 0) ? combStart : indiStart;
		
		if(nameStart >= 0) {
			var chunks = extractLine(lines[nameStart - 3]);
			
			var companyName = chunks[0];
			if(symbol && companyName) {
				companyName += " (" + symbol.toUpperCase() + ")";
			}
			writeCell(companyName, 0, 0, 1);
			chunks = extractLine(lines[nameStart - 1]);
			writeCell(chunks[0], 0, 0, 2);
			
			if(combStart >= 0) {
				writeReport(null, lines, combStart, 1);
			}
			
			if(indiStart >= 0) {
				writeReport(null, lines, indiStart, 2);
			}
			drawTable();
		}
	}
	function searchLines(lines, text) {
		var len = lines.length;
		for(var i = 0; i < len; ++i) {
			line = lines[i];
			var at = line.indexOf(text);
			if(at >= 0) {
				return i;
			}
		}
		return -1;
	}
	function writeCell(text, t, c, r) {
		var cell = getCell(t, c, r);
		if(cell) {
			cell.text = text || "";
		}
	}
	function writeMonth(line, skipFront, t, r) {
		var chunks = extractLine(line);
		var count = chunks.length;
		var param1 = chunks[count - 2];
		var param2 = chunks[count - 1];
		
		var num = skipFront ? parseFloat(param1): 1;
		if(num !== num || chunks.length === 1) {
			chunks = splitSpaces(chunks[count - 1]);
			param1 = chunks.shift();
			if(chunks.length) {
				param1 += " " + chunks.shift();
			}
			param2 = chunks.length ? chunks.join(" ") : "";
		}
		writeCell(param1, t, 1, r);
		writeCell(param2, t, 3, r); // Month cell is spanned
	}
	function writeNumbers(line, t, r) {
		var chunks = extractLine(line);
		if(chunks.length === 2) {
			var tmp = chunks;
			chunks = [tmp[0]];
			chunks = chunks.concat(splitSpaces(tmp[1]));
		}
		for(var c = 1; c < 5; ++c) {
			writeCell(chunks[c], t, c, r);
		}
		return chunks;
	}
	function writeReport(tbl, lines, start, t) {
		writeMonth(lines[start + 1], false, t, 1); // Quarter
		writeMonth(lines[start + 3], "skipFront", t, 2); // End date
		writeNumbers(lines[start + 4], t, 3); // Year
		var profits = writeNumbers(lines[start + 5], t, 4); // Profit
		writeNumbers(lines[start + 6], t, 5); // EPS
		
		writePercentChangeText(profits[2], profits[1], t, 1, 6);
		writePercentChangeText(profits[4], profits[3], t, 3, 6);
	}
	function writePercentChangeText(textCur, textNew, t, cc, r) {
		var cur = extractNumber(textCur);
		var next = extractNumber(textNew);

		if(!cur || !next) {
			writeCell("", t, cc, r);
		} else {
			var pc = calculatePercentChange(cur, next);
			var ret = Math.round(pc * 10000) / 100;
			if(ret > 0) {
				ret = "+" + ret;
				getCell(t, cc, r).style.color = "#006400";
			} else {
				getCell(t, cc, r).style.color = "#8b0000";
			}
			writeCell(ret + "%", t, cc, r);
		}
	}
	function calculatePercentChange(cur, next) {
		var abs = cur < 0 ? -cur : cur;
		var diff = next - cur;
		return diff / abs;
	}
	function extractNumber(str) {
		if(str == null) { return NaN; }
		
		var neg = (str.indexOf("(") >= 0) ? -1 : 1;
		str = str.replace(/(,|\(|\))/g, "");
		return +str * neg;
	}
	function extractLine(line) {
		if(!line) { return []; }
		
		var chunks = line.split(/  +/g);
		for(var i = chunks.length; --i >= 0;) {
			chunk = chunks[i];
			if(!chunk) {
				chunks.splice(i, 1);
			}
		}
		return chunks;
	}
	function splitSpaces(str) {
		if(str) {
			return str.split(/ +/g);
		}
		return [];
	};
</script>
</body>
</html>