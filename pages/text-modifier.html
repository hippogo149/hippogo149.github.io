<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Text Modifier</title>
	<link rel="icon" href="data:;base64,iVBORw0KGgo=">
	
	<link rel="stylesheet" href="../assets/html.css">
	<script src="../assets/por.min.js"></script>
	<script src="../assets/HtmlParser.min.js"></script>
	
	<style>
		.column {
			display: inline-block;
			line-height: 24px;
			max-width: 100%;
			width: 420px;
		}
		#paramList {
			margin-left: 8px;
		}
		#paramList input{
			width: 35px;
		}
		button {
			float: right;
		}
		textarea { 
			/* font-family: monospace; */
			display: block;
			margin-top: 4px; 
			clear: both;
			
			overflow-y: auto;
			height: 500px;
			width: 100%;
			box-sizing: border-box;
		}
		#ex_input,
		#ex_output {
			height: 240px;
		}
		
		/* white-space: nowrap; can cause performance problem for long line */
		@media (min-width: 821px) and (max-width: 1100px) {
			.column {
				width: 780px;
			}
			textarea {
				height: 300px;
			}
			#ex_input,
			#ex_output {
				height: 200px;
			}
		}
		@media (max-width: 820px) {
			.column {
				width: 380px;
			}
			textarea {
				height: 200px;
			}
			#ex_input,
			#ex_output {
				height: 120px;
			}
		}
	</style>
</head>
<body>
	<h2>Text Modifier</h2>
	<div>
		<div class="column">
			<span>Text Input: </span> <button onclick="replaceInput(event)"> Replace Input with Output </button><br>
			<textarea id="txt_input" onkeyup="onInputKeyUp(event)"></textarea>
		</div>
		<div class="column">
			<select id="mode_sel" onchange="onModeChanged(event)"></select><span id="paramList"></span><br>
			<textarea id="txt_output"></textarea>
		</div>
		<div class="column">
			Example: <br>
			<textarea id="ex_input" readonly></textarea>
			<textarea id="ex_output" readonly></textarea>
		</div>
	</div>


<script>
	var lastInput = "";
	var outputMode = 0;
	
	// option name
	var label = 0;
	var optionValue = 1;
	var operation = 2;
	var paramName = 3;
	var paramDefault = 4;
	var paramUnit = 5;
	// end option names
	
	var examples = [
		"<div><h2>Text<span></span></h2><a>Link</a></div>",
		"<div id='aa' class='bb'><h2>Text<span></span></h2><a href='ccc'>Link</a></div>",
		"<div>\n\t<h2>Text\n\t\t<span></span></h2>\n\t<a>Link</a>\n</div>",
		"https://hippogo149.github.io/pages/text-modifier.html",
		"https%3A%2F%2Fhippogo149.github.io%2Fpages%2Ftext-modifier.html",
		"Marshall, Priyansh; Wada, Shogo; Feather, Fan; Stack, Adrian; Andrews, Ken; Mansour, TJ; Vyas,Ben; Ye, Ou; Lu, Eddie",
		"Dom.toggleClass = function (elem, classStr, bool) {\nif(bool) {\nelem.classList.add(classStr);\n} else if(bool == null) {\nif(elem.classList.contains(classStr)) {\nelem.classList.remove(classStr);\n} else {\nelem.classList.add(classStr);\n}\n} else {\nelem.classList.remove(classStr);\n}\n};",
		".column {\n\tdisplay: inline-block;\n\tline-height: 24px;\n\tmax-width: 100%;\n\twidth: 500px;\n}",
		".column {\\ndisplay: inline-block;\\nline-height: 24px;\\nmax-width: 100%;\\nwidth: 500px;\\n}",
		"abcdefghijklmnopqrstuvxyzabcdefghijklmnopqrstuvxyzabcdefghijklmnopqrstuvxyzabcdefghijklmnopqrstuvxyzabcdefghijklmnopqrstuvxyzabcdefghijklmnopqrstuvxyzabcdefghijklmnopqrstuvxyzabcdefghijklmnopqrstuvxyzabcdefghijklmnopqrstuvxyzabcdefghijklmnopqrstuvxyzabcdefghijklmnopqrstuvxyzabcdefghijklmnopqrstuvxyzabcdefghijklmnopqrstuvxyz",
		".column {\\ndisplay: inline-block;\\nline-height: 24px;\\nmax-width: 100%;\\nwidth: 500px;\\n}",
		"Dom.toggleClass = function (elem, classStr, bool) {\n\tif(bool) {\n\t\telem.classList.add(classStr);\n\t} else if(bool == null) {\n\t\tif(elem.classList.contains(classStr)) {\n\t\t\telem.classList.remove(classStr);\n\t\t} else {\n\t\t\telem.classList.add(classStr);\n\t\t}\n\t} else {\n\t\telem.classList.remove(classStr);\n\t}\n};",
		"{\"a\":[1, 2, 3]; \"b\": { \"c\": \"abc\" /* comments */, \"d\": 123 }, \"c\": 456};",
		"{\"a\":[1, 2, 3]; \"b\": { \"c\": \"abc\" /* comments */, \"d\": 123 }, \"c\": 456};",
		"[\na,b,c\nd,e,f\ng,h,i\n]",
		"a\tb\tc\nd\te\tf\ng\th\ti",
		"[\n\t [\"abc\", \"b\", \"c\"]\n\t,[\"d\", \"eeeee\", \"f\"]\n\t,[\"g\", \"h\", \"iff\"]\n]",
		"abc // line comment\nabc /* block comments */",
		".column {\\n\\tdisplay: inline-block;\\n\\tline-height: 24px;\\n\\tmax-width: 100%;\\n\\twidth: 500px;\\n}",
		"elem.style.width = \"100px\";\nelem.style.height = \"200px\";\nelem.style.fontSize = \"2em\";",
		'"abc" \'cef\' \\\"ghi\\\" \\\\"jkl\\\\"',
		"\n\nA    \n\t\"B\"\n\t   C\n\nD    ",
		"[\n\t [\"header 1\", \"Header 2\", \"Head\" ]\n\t,[\"cell 1\" , \"cell2\"  , \"cell 3\"]\n\t,[1     , 2     , 3    , 4, 5]\n]"
	];
	
	var selDefs = [
		["Prettify HTML Tags (Indenting)", null, prettifyHTML, "Delimiter: ", "\\t", ""],  // 2nd param as null will run tha value 0, 1, 2, ...
		["Scriptify HTML Tags (HTML to JS)", null, convertToJS],
		["Escape HTML Entity (Tag)", null, escapeHTMLTag],
		["Encode URI Component", null, window.encodeURIComponent],
		["Decode URI Component", null, window.decodeURIComponent],
		["Split Outlook Emails", null, splitEmail],
		["Tabify JavaScript", null, tabifyJS],
		["Compress Text to a Single Line", null, compressLine],
		["Split Text Line (Convert \\n)", null, splitLine, "RegExp( ",  "\\\\n", ' , "g")'],
		["Split Long Line (Add \\n)", null, splitLongLine, "Every: ",  "100", "characters"],
		["Scriptify Text Line", null, scriptifyTextLine, "Delimiter: ", "'", ""],
		["Stringify JavaScript", null, stringifyJS, "Delimiter: ", "'", ""],
		["Stringify JSON", null, stringifyJSON],
		["Prettify JSON", null, prettifyJSON, "Delimiter: ", "  "],
		["Convert Text to TSV", null, tabularFormat], // TSV = Tab-Separated Values
		["Convert TSV to 2D Array", null, scriptifyTsv],
		["Prettify 2D Array", null, prettify2DArray],
		["Strip comments", null, stripComments],
		["Strip escaped spaces", null, stripEscapedSpaces],
		["Convert JS to CSS", null, jsToCss],
		["Escape Double Quotation Mark", null, escapeDoubleQuotes],
		["Convert Text List to Array", null, textToArray, "Keep NewLine: ", "false"],
		["2D Array to Markdown Table", null, arrayToMarkdown]
	];
	
	Dom.options(mode_sel, selDefs, outputMode);
	
	var param1 = Dom.texts("",  Dom.tag("input"), "");
	var paramRef = Dom.map(param1, ["name", "in", "closure"]);
	param1.ref = paramRef;
	param1.ref.in.onkeyup = function() {
		lastInput = "";
		ex_output.value = resolveOutput(ex_input.value);
		onInputKeyUp();
	};
	param1.ref.in.onfocus = function(e) {
		e.currentTarget.select();
	};
	
	var cf = new Conflator(onInputKeyUp, 1000);
	
	
	InputStorage.restore();
	txt_output.value = ""; // Clear the saved value
	onModeChanged();
	
	// Main Work Flows
	function replaceInput() {
		txt_input.value = txt_output.value;
	}
	
	function onInputKeyUp() {
		if(cf.conflate()) { return; }
		
		var inputStr = txt_input.value;
		if(!inputStr || inputStr === lastInput) { return; }
		lastInput = inputStr;
		InputStorage.save();
		
		txt_output.value = resolveOutput(inputStr);
	}
	function resolveOutput(inputStr) {
		var def = selDefs[outputMode];
		return def ? def[operation](inputStr, param1.ref.in.value) : "";
	}
	
	function onModeChanged() {
		lastInput = ""; // Clear last input
		outputMode = +mode_sel.selectedOptions[0].value;
		var def = selDefs[outputMode];
		if(def[paramName]) {
			param1.ref.name.textContent = def[paramName];
			param1.ref.in.value = def[paramDefault];
			param1.ref.closure.textContent = def[paramUnit];
			paramList.appendChild(param1);
		} else {
			Dom.removeChildren(paramList);
		}
		
		var ex_str = examples[outputMode] || "";
		ex_input.value = ex_str;
		ex_output.value = resolveOutput(ex_str);
		
		onInputKeyUp();
	}
	
	// Output Modes
	function prettifyHTML(str, delim) {
		if(HtmlParser) {
			return HtmlParser.prettify(str, replaceAll(delim, "\\t", "\t"));
		}
		return "Error";
	}
	function convertToJS(str) {
		if(HtmlParser) {
			return HtmlParser.scriptify(str);
		}
		return "Error";
	}
	function compressLine(str) {
		var outStr = str.replace(/ ;[^\n]*\n/g, ";\n");
		outStr = replaceAll(outStr, '"', '\\"');
		outStr = replaceAll(outStr, "'", "\\'");
		outStr = replaceAll(outStr, 10, "\\n");
		outStr = replaceAll(outStr, 9, "\\t");
		outStr = replaceAll(outStr, "  ", " ");
		return outStr;
	}
	function splitEmail(str) {
		var outStr = str.replace(/\s*\([^\)]*\)/g, "");
		outStr = outStr.replace(/;\s*/g, "\n");
		return outStr;
	}
	function splitLine(str, delim) {
		var regEx = new RegExp(delim, "g");
		return str.replace(regEx, "\n");
	}
	function splitLongLine(str, chCount) {
		chCount = +chCount;
		if(!chCount || chCount < 0) {
			chCount = 200;
		}
		
		var ary = [];
		var strLen = str.length;
		for(var startAt = 0; startAt < strLen; startAt += chCount) {
			ary.push(str.substr(startAt, chCount));
		}
		return ary.join("\n");
	}
	function escapeHTMLTag(str) {
		return replaceAll(str, "<", "&lt;");
	}
	function tabifyJS(str) {
		var lines = str.split(/\n/g);
		var len = lines.length;
		var curLvl = 0;
		var maxLvl = 0;
		var levels = new Array(len);
		levels.fill(0);
		for(var i = 0; i < len; ++i) {
			var line = lines[i];
			line = line.replace(/^[ \t]*/, "");
			lines[i] = line;
			levels[i] = curLvl;
			if(line) {
				var start = line.indexOf("{");
				var closure = line.indexOf("}");
				if(closure >= 0) {
					if(start < 0) {
						if(curLvl > 0) { --curLvl; }
						levels[i] = curLvl;
					} else if(closure < start) {
						levels[i] = curLvl ? curLvl - 1: 0;
					}
				} else if(start >= 0) {
					++curLvl;
					if(curLvl > maxLvl) {
						maxLvl = curLvl;
					}
				}
			}
		}
		var tabs = window._tabStrings;
		if(!tabs) {
			tabs = [""];
			window._tabStrings = tabs;
		}
		while(tabs.length <= maxLvl) {
			tabs.push(tabs[tabs.length - 1] + "\t");
		}
		
		for(i = 0; i < len; ++i) {
			line = lines[i];
			if(line) {
				lines[i] = tabs[levels[i]] + line;
			}
		}
		return lines.join("\n");
	}
	function scriptifyTextLine(str, delim) {
		str = str.replace(/\\r\\n/g, "\\n");
		var lines = str.split("\\n");
		var len = lines.length;
		for(var i = 0; i < len; ++i) {
			var line = lines[i];
			lines[i] = delim + line;
		}
		return lines.join("\\n" + delim + " +\n") + delim;
	}
	function stringifyJS(str, delim) {
		str = tabifyJS(str);
		str = compressLine(str);
		str = scriptifyTextLine(str, delim);
		return str;
	}
	function stringifyJSON(str) {
		var obj = Ut.parseJSON(str);
		var mod = JSON.stringify(obj);
		return '"' + replaceAll(mod, '"', '\\"') + '"';
		return str;
	}
	function prettifyJSON(str, delim) {
		var obj = Ut.parseJSON(str);
		if(!delim) {
			delim = 2;
		} else if(delim == "\\t") {
			delim = "\t";
		}
		return JSON.stringify(obj, null, delim);
	}
	function tabularFormat(str) { // Text to TXV
		str = str.replace(/\[|\]|"|'/g, ""); // Allow JS Array to be transformed
		var tbl = Ary.toTable(str);
		str = Ary.tableToString(tbl); // To TSV format string
		return str.trim(); // IE9+
	}
	function scriptifyTsv(str) {
		str = str.trim(); // IE9+
		var tbl = Ary.toTable(str, null, "\t");
		return joinStrTableArray(tbl);
	}
	function joinStrTableArray(tbl) {
		var rowCount = tbl.length;
		if(rowCount <= 0) {
			return "[]";
		}
		var firstRow = tbl[0];
		if(!Array.isArray(firstRow)) {
			return JSON.stringify(tbl);
		}
		
		// String Array only. TODO: Handle more data type
		var str = "[\n";
		str += '\t ["' + firstRow.join('", "') + '"]';
		for(r = 1; r < rowCount; ++r) {
			var row = tbl[r];
			str += '\n\t,["' + row.join('", "') + '"]';
		}
		return str + "\n]";
	};
	function removeArrayGaps(aryStr) {
		return aryStr.replace(/ *, */g, ",") // Strip all spaces around a comma
			.replace(/\[ +/g, "[") // Strip all spaces after open bracket
			.replace(/ +\]/g, "]"); // Strip all spaces before close bracket
	}
	function prettify2DArray(str) {
		var out_str = str.replace(/[\r\n\t]/g, ""); // Strip all new lines and tabs
		out_str = out_str.trim(); // IE9+
		out_str = out_str.replace(/;\s*$/, ""); // Remove ending semicolon
		
		if(!out_str.match(/^\[ *\[.*\] *\]$/)) {
			return out_str; // Invalid input
		}
		out_str = removeArrayGaps(out_str);
		
		out_str = out_str.substr(2, out_str.length - 4); // Strip outer brackets
		
		var tbl = out_str.split("],["); // Array of rows
		var rowCount = tbl.length;
		var maxLens = [];
		for(var r = 0; r < rowCount; ++r) {
			var strRow = tbl[r];
			var row = strRow.split(",");
			tbl[r] = row;
			var colCount = row.length;
			for(var c = 0; c < colCount; ++c) {
				var str = row[c];
				var strLen = (str) ? str.length : 0;
				if(!(strLen <= maxLens[c])) {
					maxLens[c] = strLen;
				}
			}
		}
		colCount = maxLens.length;
		for(c = 0; c < colCount; ++c) {
			var maxLen = maxLens[c];
			for(r = 0; r < rowCount; ++r) {
				row = tbl[r];
				str = row[c];
				if(str) {
					strLen = str.length;
					while(strLen++ < maxLen) {
						str += " ";
					}
					row[c] = str;
				}
			}
		}
		
		
		var firstRow = tbl[0];
		out_str= "[\n";
		out_str += '\t [' + firstRow.join(', ') + ']';
		for(r = 1; r < rowCount; ++r) {
			var row = tbl[r];
			out_str += '\n\t,[' + row.join(', ') + ']';
		}
		return out_str + "\n]";
	}
	function stripComments(str) {
		str = str.replace(/\/\*[\s\S]*?\*\//g, ""); // Slash star enclosure
		return str.replace(/\/\/[\s\S]*?\n/g, "\n"); // Double slashes
	}
	function stripEscapedSpaces(str) {
		return str.replace(/(\\n|\\t)/g, "");
	}
	function jsToCss(str) {
		var out_str = "";
		str.replace(/\.style\.(.+)/g, function(val, grp1) {
			var parts = grp1.split("=");
			if(parts.length == 2) {
				var val = capToSnake(parts[0].replace(/\s/g, "")) + ":" + valToCssVal(parts[1]);
				if(out_str) {
					out_str += "\n";
				}
				out_str += val;
			}
		});
		return out_str;
	}
	function capToSnake(str) {
		return str.replace(/[A-Z]/g, addSnake);
	}
	function addSnake(str) {
		return "-" + smallToBig(str);
	}
	function smallToBig(str) {
		return String.fromCharCode(str.charCodeAt(0) + 32);
	}
	function valToCssVal(str) {
		return str.replace(/['"]([^'"]*)['"]/, "$1");
	}
	function escapeDoubleQuotes(str) {
		return str.replace(/\\*"/g, replaceDoubleQuotes);
	}
	function replaceDoubleQuotes(str) {
		return (str.length & 1) ? "\\" + str : str;
	}
	function textToArray(str, delim) {
		str = escapeDoubleQuotes(str.replace(/[\r\t]/g, ""));
		var chunks = str.split("\n");
		chunks = chunks.map(function(val) {
			return val.trim();
		});
		if(!delim || delim === "false" || delim === "0") {
			chunks = chunks.filter(function(val) {
				return val ? true : false;
			});
		}
		return "[\n\t\"" + chunks.join("\",\n\t\"") + "\"\n]";
	}
	function arrayToMarkdown(str) {
		str = str.replace(/[\r\n\t"';]/g, ""); // Strip non essential content
		str = removeArrayGaps(str);
		var rows = str.split("],[");
		var header = null;
		var contents = [];
		var rowCount = rows.length;
		var maxColCount = 0;
		var c, colCount;
		for(var r = 0; r < rowCount; ++r) {
			var rowStr = rows[r];
			var cols = rowStr.replace(/\[|\]/g, "").split(",");
			colCount = cols.length;
			if(colCount > maxColCount) {
				maxColCount = colCount;
			}
			if(r) {
				contents.push(cols);
			} else {
				header = cols;
			}
		}
		if(!header) {
			return "null";
		}
		colCount = maxColCount;
		var separators = new Array(colCount);
		for(c = 0; c < colCount; ++c) {
			if(!header[c]) {
				header[c] = "-";
			}
			separators[c] = "---";
		}
		var table = [header.join(" | "), separators.join(" | ")];
		rowCount = contents.length;
		for(r = 0; r < rowCount; ++r) {
			cols = contents[r];
			for(c = 0; c < colCount; ++c) {
				var cellStr = cols[c];
				if(cellStr) {
					cols[c] = cellStr.replace(/\|/g, "\\|");
				} else {
					cols[c] = " ";
				}
			}
			table.push(cols.join(" | "));
		}
		
		return table.join("\n");
	}
	
	// Helper
	function replaceAll(hayStack, needle, replacer) {
		if(typeof needle === "number") {
			needle = String.fromCharCode(needle);
		}
		var chunks = hayStack.split(needle);
		if(chunks.length <= 1) {
			return hayStack;
		}
		
		if(typeof replacer === "number") {
			replacer = String.fromCharCode(replacer);
		}
		if(!replacer) {
			replacer = "";
		}
		return chunks.join(replacer);
	}
</script>
</body>
</html>