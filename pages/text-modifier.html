<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Text Modifier</title>
	<link rel="icon" href="data:;base64,iVBORw0KGgo=">
	
	<link rel="stylesheet" href="../assets/html.css">
	<script src="../assets/por.min.js"></script>
	
	<style>
		.column {
			display: inline-block;
			line-height: 24px;
		}
		#paramList {
			margin-left: 8px;
		}
		textarea { 
			margin-top: 4px; 
			
			overflow-y: auto;
			height: 600px;
		}
		
		@media all and (min-width: 1101px) {
			textarea { 
				overflow-x: auto;
				white-space: nowrap;
			}
			#txt_input {
				width: 480px;
			}
			#txt_output {
				width: 640px;
			}
		}
		@media all and (max-width: 1100px) {
			textarea { 
				overflow-x: hidden;
			}
			#txt_input {
				height: 200px;
			}
			#txt_output {
				height: 300px;
			}
		}
		@media all and (min-width: 821px) and (max-width: 1100px) {
			textarea {
				width: 780px;
			}
		}
		@media all and (max-width: 820px) {
			textarea {
				width: 450px;
			}
		}
	</style>
	<script type="text/javascript">
		window.addEventListener("load", function() {
			var winTitle = "Text Modifier";
			if(winTitle) {
				document.title = winTitle;
				var header = document.createElement("h2");
				header.textContent = winTitle;
				document.body.insertBefore(header, document.body.firstChild);
			}
		}, false);
	</script>
</head>
<body>
	<div>
		<div class="column">
			Text Input: <button onclick="replaceInput(event)"> Replace Input with Output </button><br>
			<textarea id="txt_input" onkeyup="onInputKeyUp(event)"></textarea>
		</div>
		<div class="column">
			Output: <select id="mode_sel" onchange="onModeChanged(event)"></select><span id="paramList"></span><br>
			<textarea id="txt_output"></textarea>
		</div>
	</div>


<script type='text/javascript'>
	var lastInput = "";
	var outputMode = 0;
	
	// option name
	var label = 0;
	var optionValue = 1;
	var operation = 2;
	var paramName = 3;
	var paramDefault = 4;
	var paramUnit = 5;
	// end option names
	
	var selDefs = [
		["Prettify HTML Tags (Indenting)", null, prettifyHTML, "Delimiter: ", "\\t", ""],  // 2nd param as null will run tha value 0, 1, 2, ...
		["Scriptify HTML Tags (HTML to JS)", null, convertToJS],
		["Escape HTML Entity (Tag)", null, escapeHTMLTag],
		["Encode URI Component", null, window.encodeURIComponent],
		["Decode URI Component", null, window.decodeURIComponent],
		["Split Outlook Emails", null, splitEmail],
		["Tabify JavaScript", null, tabifyJS],
		["Compress Text to a Single Line", null, compressLine],
		["Split Text Line (Convert \\n)", null, splitLine, "RegExp( ",  "\\\\n", ' , "g")'],
		["Scriptify Text Line", null, scriptifyTextLine, "Delimiter: ", "'", ""],
		["Stringify JavaScript", null, stringifyJS, "Delimiter: ", "'", ""],
		["Stringify JSON", null, stringifyJSON],
		["Convert Text to TSV", null, tabularFormat], // TSV = Tab-Separated Values
		["Convert TSV to 2D Array", null, scriptifyTsv]
	];
	
	Dom.options(mode_sel, selDefs, outputMode);
	
	var param1 = Dom.texts("",  Dom.textInput(null, 40), "");
	var paramRef = Dom.map(param1, ["name", "in", "closure"]);
	param1.ref = paramRef;
	param1.ref.in.onkeyup = function() {
		lastInput = "";
		onInputKeyUp();
	};
	
	var cf = new Conflator(onInputKeyUp, 1000);
	
	
	InputStorage.restore();
	onModeChanged();
	
	// Main Work Flows
	function replaceInput() {
		txt_input.value = txt_output.value;
	}
	
	function onInputKeyUp() {
		if(cf.conflate()) { return; }
		
		var inputStr = txt_input.value;
		if(!inputStr || inputStr === lastInput) { return; }
		lastInput = inputStr;
		InputStorage.save();
		
		var def = selDefs[outputMode];
		txt_output.value = def[operation](inputStr, param1.ref.in.value);
	}
	
	function onModeChanged() {
		lastInput = ""; // Clear last input
		outputMode = +mode_sel.selectedOptions[0].value;
		var def = selDefs[outputMode];
		if(def[paramName]) {
			param1.ref.name.textContent = def[paramName];
			param1.ref.in.value = def[paramDefault];
			param1.ref.closure.textContent = def[paramUnit];
			paramList.appendChild(param1);
		} else {
			Dom.removeChildren(paramList);
		}
		onInputKeyUp();
	}
	
	// Output Modes
	function prettifyHTML(str, delim) {
		if(HtmlParser) {
			return HtmlParser.prettify(str, replaceAll(delim, "\\t", "\t"));
		}
		return "Error";
	}
	function convertToJS(str) {
		if(HtmlParser) {
			return HtmlParser.scriptify(str);
		}
		return "Error";
	}
	function compressLine(str) {
		var outStr = str.replace(/ ;[^\n]*\n/g, ";\n");
		outStr = replaceAll(outStr, '"', '\\"');
		outStr = replaceAll(outStr, "'", "\\'");
		outStr = replaceAll(outStr, 10, "\\n");
		outStr = replaceAll(outStr, 9, "\\t");
		outStr = replaceAll(outStr, "  ", " ");
		return outStr;
	}
	function splitEmail(str) {
		var outStr = str.replace(/\s*\([^\)]*\)/g, "");
		outStr = outStr.replace(/;\s*/g, "\n");
		return outStr;
	}
	function splitLine(str, delim) {
		var regEx = new RegExp(delim, "g");
		return str.replace(regEx, "\n");
	}
	function escapeHTMLTag(str) {
		return replaceAll(str, "<", "&lt;");
	}
	function tabifyJS(str) {
		var lines = str.split(/\n/g);
		var len = lines.length;
		var curLvl = 0;
		var maxLvl = 0;
		var levels = new Array(len);
		levels.fill(0);
		for(var i = 0; i < len; ++i) {
			var line = lines[i];
			line = line.replace(/^[ \t]*/, "");
			lines[i] = line;
			levels[i] = curLvl;
			if(line) {
				var start = line.indexOf("{");
				var closure = line.indexOf("}");
				if(closure >= 0) {
					if(start < 0) {
						if(curLvl > 0) { --curLvl; }
						levels[i] = curLvl;
					} else if(closure < start) {
						levels[i] = curLvl ? curLvl - 1: 0;
					}
				} else if(start >= 0) {
					++curLvl;
					if(curLvl > maxLvl) {
						maxLvl = curLvl;
					}
				}
			}
		}
		var tabs = window._tabStrings;
		if(!tabs) {
			tabs = [""];
			window._tabStrings = tabs;
		}
		while(tabs.length <= maxLvl) {
			tabs.push(tabs[tabs.length - 1] + "\t");
		}
		
		for(i = 0; i < len; ++i) {
			line = lines[i];
			if(line) {
				lines[i] = tabs[levels[i]] + line;
			}
		}
		return lines.join("\n");
	}
	function scriptifyTextLine(str, delim) {
		str = str.replace(/\\r\\n/g, "\\n");
		var lines = str.split("\\n");
		var len = lines.length;
		for(var i = 0; i < len; ++i) {
			var line = lines[i];
			lines[i] = delim + line;
		}
		return lines.join("\\n" + delim + " +\n") + delim;
	}
	function stringifyJS(str, delim) {
		str = tabifyJS(str);
		str = compressLine(str);
		str = scriptifyTextLine(str, delim);
		return str;
	}
	function stringifyJSON(str) {
		try {
			var obj = JSON.parse(str);
			var mod = JSON.stringify(obj);
			return '"' + replaceAll(mod, '"', '\\"') + '"';
		} catch (err) {
			console.warn(err.message);
		}
		return str;
	}
	function tabularFormat(str) {
		str = str.replace(/\[|\]|"|'/g, ""); // Allow JS Array to be transformed
		var tbl = Ary.toTable(str);
		return Ary.tableToString(tbl); // To TSV format string
	}
	function scriptifyTsv(str) {
		str = str.trim(); // IE9+
		var tbl = Ary.toTable(str, null, "\t");
		var rowCount = tbl.length;
		if(rowCount <= 0) {
			return "[]";
		}
		var str = "[\n";
		str += '\t ["' + tbl[0].join('", "') + '"]';
		for(r = 1; r < rowCount; ++r) {
			var row = tbl[r];
			str += '\n\t,["' + row.join('", "') + '"]';
		}
		return str + "\n]";
	}
	
	// Helper
	function replaceAll(hayStack, needle, replacer) {
		if(typeof needle === "number") {
			needle = String.fromCharCode(needle);
		}
		var chunks = hayStack.split(needle);
		if(chunks.length <= 1) {
			return hayStack;
		}
		
		if(typeof replacer === "number") {
			replacer = String.fromCharCode(replacer);
		}
		if(!replacer) {
			replacer = "";
		}
		return chunks.join(replacer);
	}
</script>
</body>
</html>